# This workflow builds the SilentXMRMiner project using .NET on Windows.
# It will run automatically when changes are pushed to the 'master' branch
# or when a pull request is opened against the 'master' branch.

name: Build SilentXMRMiner

on:
  push:
    branches:
      - master # Change this to 'main' if your default branch is named 'main'
  pull_request:
    branches:
      - master # Change this to 'main' if your default branch is named 'main'

jobs:
  build:
    # Use the latest Windows environment.
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      # Clones the repository to the runner.
      uses: actions/checkout@v4

    - name: Install .NET Framework 4.5 Targeting Pack via Visual Studio Installer
      # Explicitly installs the .NET Framework 4.5 Targeting Pack using the Visual Studio Installer.
      # This is the most reliable method to ensure the necessary reference assemblies are present.
      shell: powershell
      run: |
        # Find the path to the Visual Studio Installer executable
        $vsInstallerPath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\setup.exe"
        if (-not (Test-Path $vsInstallerPath)) {
            $vsInstallerPath = "${env:ProgramFiles}\Microsoft Visual Studio\Installer\setup.exe"
        }
        
        if (-not (Test-Path $vsInstallerPath)) {
            Write-Error "Visual Studio Installer not found at expected paths."
            exit 1
        }

        # Install the .NET Framework 4.5 Targeting Pack component
        Write-Host "Installing .NET Framework 4.5 Targeting Pack..."
        & "$vsInstallerPath" update --installPath "C:\Program Files\Microsoft Visual Studio\2022\Enterprise" --add Microsoft.Net.Component.4.5.TargetingPack --quiet --norestart
        if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to install .NET Framework 4.5 Targeting Pack."
            exit 1
        }
        Write-Host ".NET Framework 4.5 Targeting Pack installation complete."

    - name: Setup MSBuild
      # Installs the necessary MSBuild tools. This action is still useful for setting up the environment.
      uses: microsoft/setup-msbuild@v1.1

    - name: Restore NuGet Packages
      # Restores all NuGet packages required by the solution using MSBuild's restore target.
      # This is the correct way to restore packages for .NET Framework projects.
      run: msbuild SilentXMRMiner.sln /t:Restore

    - name: Build Project
      # Builds the project in Release configuration using MSBuild.
      # The /p:Configuration=Release flag sets the build configuration.
      # The /p:Platform="Any CPU" is often needed for .NET Framework projects.
      run: msbuild SilentXMRMiner.sln /p:Configuration=Release /p:Platform="Any CPU"

    - name: Publish Build Artifacts
      # Optional: Uploads the compiled executable as a workflow artifact.
      # This makes the build output easily downloadable from the GitHub Actions run summary.
      # Adjust the 'path' to match where your compiled .exe is located after building.
      # Common paths are 'SilentXMRMiner/bin/Release/net8.0/' or similar, depending on your project structure and target framework.
      uses: actions/upload-artifact@v4
      with:
        name: SilentXMRMiner-Executable
        path: SilentXMRMiner/bin/Release/net45/ # Adjusted path to reflect .NET Framework 4.5 output
        # If your project is a single .exe, you might specify: path: SilentXMRMiner/bin/Release/net45/SilentXMRMiner.exe
        # Or if it's a self-contained deployment: path: SilentXMRMiner/bin/Release/net45/publish/
